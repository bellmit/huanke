<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huanke.iot.base.dao.device.DeviceMapper">

    <sql id="tableName">
        t_device
    </sql>
    <!-- 插入一条记录 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.huanke.iot.base.po.device.DevicePo">
        INSERT INTO
        <include refid="tableName"/>
        (
        name,
        mac,
        wxDeviceId,
        wxDevicelicence,
        wxQrticket,
        imei,
        imsi,
        saNo,
        typeId,
        modelId,
        productId,
        onlineStatus,
        bindStatus,
        bindTime,
        assignStatus,
        assignTime,
        enableStatus,
        workStatus,
        ip,
        speedConfig,
        version,
        location,
        status,
        hardVersion,
        communicationVersion,
        softVersion,
        birthTime,
        hostStatus,
        hostDeviceId,
        childId,
        createTime,
        lastUpdateTime,
        createUserId,
        updateUserId
        )
        VALUES
        (
        #{name},
        #{mac},
        #{wxDeviceId},
        #{wxDevicelicence},
        #{wxQrticket},
        #{imei},
        #{imsi},
        #{saNo},
        #{typeId},
        #{modelId},
        #{productId},
        #{onlineStatus},
        #{bindStatus},
        #{bindTime},
        #{assignStatus},
        #{assignTime},
        #{enableStatus},
        #{workStatus},
        #{ip},
        #{speedConfig},
        #{version},
        #{location},
        #{status},
        #{hardVersion},
        #{communicationVersion},
        #{softVersion},
        #{birthTime},
        #{hostStatus},
        #{hostDeviceId},
        #{childId},
        #{createTime},
        #{lastUpdateTime},
        #{createUserId},
        #{updateUserId}
        )
    </insert>

    <!-- 批量插入数条记录 -->
    <insert id="insertBatch" useGeneratedKeys="true" keyProperty="id" parameterType="List">
        INSERT INTO
        <include refid="tableName"/>
        (
        name,
        mac,
        wxDeviceId,
        wxDevicelicence,
        wxQrticket,
        imei,
        imsi,
        saNo,
        typeId,
        modelId,
        productId,
        onlineStatus,
        bindStatus,
        bindTime,
        assignStatus,
        assignTime,
        enableStatus,
        workStatus,
        ip,
        speedConfig,
        version,
        location,
        status,
        hardVersion,
        communicationVersion,
        softVersion,
        birthTime,
        hostStatus,
        hostDeviceId,
        childId,
        createTime,
        lastUpdateTime,
        createUserId,
        updateUserId
        )
        VALUES
        <foreach collection="list" item="device" separator=",">
            (
            #{device.name},
            #{device.mac},
            #{device.wxDeviceId},
            #{device.wxDevicelicence},
            #{device.wxQrticket},
            #{device.imei},
            #{device.imsi},
            #{device.saNo},
            #{device.typeId},
            #{device.modelId},
            #{device.productId},
            #{device.onlineStatus},
            #{device.bindStatus},
            #{device.bindTime},
            #{device.assignStatus},
            #{device.assignTime},
            #{device.enableStatus},
            #{device.workStatus},
            #{device.ip},
            #{device.speedConfig},
            #{device.version},
            #{device.location},
            #{device.status},
            #{device.hardVersion},
            #{device.communicationVersion},
            #{device.softVersion},
            #{device.birthTime},
            #{device.hostStatus},
            #{device.hostDeviceId},
            #{device.childId},
            #{device.createTime},
            #{device.lastUpdateTime},
            #{device.createUserId},
            #{device.updateUserId}
            )
        </foreach>
    </insert>

    <select id="selectById" parameterType="java.lang.Integer" resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        *
        FROM
        <include refid="tableName"/>
        WHERE id = #{id} limit 1
    </select>

    <select id="selectByMac" parameterType="java.lang.String" resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        *
        FROM
        <include refid="tableName"/>
        WHERE
        mac = #{mac}
        AND
        status = 1
        limit 1
    </select>

    <select id="selectByName" parameterType="java.lang.String" resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        *
        FROM
        <include refid="tableName"/>
        WHERE name = #{name} limit 1
    </select>
    <select id="selectDeviceCustomerRelationByMac" parameterType="java.lang.String"
            resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        t_device.*
        FROM
        t_device,t_device_customer_relation
        WHERE t_device.mac = #{mac}
         AND t_device.id = t_device_customer_relation.deviceId
         limit 1
    </select>


    <select id="selectBySaNo" parameterType="java.lang.String" resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        *
        FROM
        <include refid="tableName"/>
        WHERE saNo = #{saNo} limit 1
    </select>


    <select id="selectByModelId" parameterType="java.lang.Integer" resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        *
        FROM
        <include refid="tableName"/>
        WHERE modelId = #{modelId}
    </select>


    <select id="selectList" resultType="com.huanke.iot.base.po.device.DevicePo">
        select * from
        t_device d
        <if test="param.customerId != null">
            ,t_device_customer_relation r
        </if>
        <where>
            1=1
            <if test="param.mac != null and param.mac != ''">
                AND d.mac = #{param.mac}
            </if>
            <if test="param.saNo != null and param.saNo != ''">
                AND d.saNo = #{param.saNo}
            </if>
            <if test="param.name != null  and param.name != ''  ">
                AND d.name like CONCAT('%',CONCAT(#{param.name},'%'))
            </if>
            <if test="param.customerId != null">
                AND r.customerId = #{param.customerId}
                and d.id = r.deviceId
            </if>
            <if test="param.onlineStatus != null">
                AND d.onlineStatus = #{param.onlineStatus}
            </if>
            <if test="param.bindStatus != null">
                AND d.bindStatus = #{param.bindStatus}
            </if>
            <if test="param.assignStatus != null">
                AND d.assignStatus = #{param.assignStatus}
            </if>
            <if test="param.enableStatus != null">
                AND d.enableStatus = #{param.enableStatus}
            </if>
            <if test="param.workStatus != null">
                AND d.workStatus = #{param.workStatus}
            </if>
            <if test="param.status != null">
                AND d.status = #{param.status}
            </if>
            AND d.hostDeviceId is null
        </where>
        limit #{offset},#{limit}
    </select>

    <select id="selectCount" resultType="java.lang.Integer">
        select count(1) from
        t_device d
        <if test="param.customerId != null">
            ,t_device_customer_relation r
        </if>
        <where>
            1=1
            <if test="param.mac != null and param.mac != ''">
                AND d.mac = #{param.mac}
            </if>
            <if test="param.saNo != null and param.saNo != ''">
                AND d.saNo = #{param.saNo}
            </if>
            <if test="param.name != null  and param.name != ''  ">
                AND d.name like CONCAT('%',CONCAT(#{param.name},'%'))
            </if>
            <if test="param.customerId != null">
                AND r.customerId = #{param.customerId}
                and d.id = r.deviceId
            </if>
            <if test="param.onlineStatus != null">
                AND d.onlineStatus = #{param.onlineStatus}
            </if>
            <if test="param.bindStatus != null">
                AND d.bindStatus = #{param.bindStatus}
            </if>
            <if test="param.assignStatus != null">
                AND d.assignStatus = #{param.assignStatus}
            </if>
            <if test="param.enableStatus != null">
                AND d.enableStatus = #{param.enableStatus}
            </if>
            <if test="param.workStatus != null">
                AND d.workStatus = #{param.workStatus}
            </if>
            <if test="param.status != null">
                AND d.status = #{param.status}
            </if>
            AND d.hostDeviceId is null
        </where>
    </select>

    <select id="selectByWxDeviceId" parameterType="java.lang.String"
            resultType="com.huanke.iot.base.po.device.DevicePo">
        select
        *
        FROM
        <include refid="tableName"/>
        WHERE wxDeviceId = #{wxDeviceId}
        AND status = 1
        limit 1
    </select>

    <!--单条更新-->
    <update id="updateByDeviceId" parameterType="com.huanke.iot.base.po.device.DevicePo">

        update
        <include refid="tableName"/>
        <set>
            <if test="name != null  and name!='' ">
                name = #{name},
            </if>
            <if test="wxDeviceId != null and wxDeviceId!='' ">
                wxDeviceId = #{wxDeviceId},
            </if>
            <if test="wxDevicelicence != null and wxDevicelicence!='' ">
                wxDevicelicence = #{wxDevicelicence},
            </if>
            <if test="wxQrticket != null and wxQrticket!='' ">
                wxQrticket = #{wxQrticket},
            </if>
            <if test="imei != null and imei != '' ">
                imei = #{imei},
            </if>
            <if test="imsi != null and imsi != ''">
                imsi = #{imsi},
            </if>
            <if test="saNo != null and saNo != '' ">
                saNo = #{saNo},
            </if>
            <if test="typeId != null">
                typeId = #{typeId},
            </if>
            <if test="modelId != null">
                modelId = #{modelId},
            </if>
            <if test="productId != null and productId!='' ">
                productId = #{productId},
            </if>
            <if test="onlineStatus != null">
                onlineStatus = #{onlineStatus},
            </if>
            <if test="assignStatus != null">
                assignStatus = #{assignStatus},
            </if>
            <if test="bindStatus != null">
                bindStatus = #{bindStatus},
            </if>
            <if test="bindTime != null">
                bindTime = #{bindTime},
            </if>
            <if test="enableStatus != null">
                enableStatus = #{enableStatus},
            </if>
            <if test="workStatus != null">
                workStatus = #{workStatus},
            </if>
            <if test="ip != null and ip != '' ">
                ip = #{ip},
            </if>
            <if test="speedConfig != null">
                speedConfig = #{speedConfig},
            </if>
            <if test="version != null and version != '' ">
                version = #{version},
            </if>
            <if test="location != null and location != '' ">
                location = #{location},
            </if>
            <if test="lastUpdateTime != null">
                lastUpdateTime = #{lastUpdateTime},
            </if>
            <if test="updateUserId != null">
                updateUserId = #{updateUserId},
            </if>
        </set>
        where
        1= 1
        and wxDeviceId = #{wxDeviceId}

    </update>

    <update id="updateById" parameterType="com.huanke.iot.base.po.device.DevicePo">

        update
        <include refid="tableName"/>
        <set>
            <if test="name != null  and name!='' ">
                name = #{name},
            </if>
            <if test="wxDeviceId != null and wxDeviceId!='' ">
                wxDeviceId = #{wxDeviceId},
            </if>
            <if test="wxDevicelicence != null and wxDevicelicence!='' ">
                wxDevicelicence = #{wxDevicelicence},
            </if>
            <if test="wxQrticket != null and wxQrticket!='' ">
                wxQrticket = #{wxQrticket},
            </if>
            <if test="imei != null and imei != '' ">
                imei = #{imei},
            </if>
            <if test="imsi != null and imsi != ''">
                imsi = #{imsi},
            </if>
            <if test="saNo != null and saNo != '' ">
                saNo = #{saNo},
            </if>
            <if test="typeId != null">
                typeId = #{typeId},
            </if>
            <if test="modelId != null">
                modelId = #{modelId},
            </if>
            <if test="productId != null and productId!='' ">
                productId = #{productId},
            </if>
            <if test="onlineStatus != null">
                onlineStatus = #{onlineStatus},
            </if>
            <if test="bindStatus != null">
                bindStatus = #{bindStatus},
            </if>
            <if test="assignStatus != null">
                assignStatus = #{assignStatus},
            </if>
            <if test="enableStatus != null">
                enableStatus = #{enableStatus},
            </if>
            <if test="workStatus != null">
                workStatus = #{workStatus},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="ip != null and ip != '' ">
                ip = #{ip},
            </if>
            <if test="speedConfig != null">
                speedConfig = #{speedConfig},
            </if>
            <if test="version != null and version != '' ">
                version = #{version},
            </if>
            <if test="location != null and location != '' ">
                location = #{location},
            </if>
            <if test="bindTime != null">
                bindTime = #{bindTime},
            </if>
            <if test="lastUpdateTime != null">
                lastUpdateTime = #{lastUpdateTime},
            </if>
            <if test="updateUserId != null">
                updateUserId = #{updateUserId}
            </if>
        </set>
        where
        1= 1
        and id = #{id}
    </update>

    <!--批量更新-->
    <update id="updateBatch" parameterType="java.util.List">
        update
        <include refid="tableName"/>
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="name =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    <if test="device.name !=null">
                        when id=#{device.id} then #{device.name}
                    </if>
                </foreach>
            </trim>
            <trim prefix="modelId =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    when id=#{device.id} then #{device.modelId}
                </foreach>
            </trim>

            <trim prefix="productId =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    when id=#{device.id} then #{device.productId}
                </foreach>
            </trim>
            <trim prefix="wxDeviceId =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    when id=#{device.id} then #{device.wxDeviceId}
                </foreach>
            </trim>
            <trim prefix="wxDevicelicence =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    when id=#{device.id} then #{device.wxDevicelicence}
                </foreach>
            </trim>
            <trim prefix="assignStatus =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    <if test="device.assignStatus !=null">
                        when id=#{device.id} then #{device.assignStatus}
                    </if>
                </foreach>
            </trim>
            <trim prefix="assignTime =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    when id=#{device.id} then #{device.assignTime}
                </foreach>
            </trim>
            <trim prefix="bindStatus =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    <if test="device.bindStatus !=null">
                        when id=#{device.id} then #{device.bindStatus}
                    </if>
                </foreach>
            </trim>
            <trim prefix="bindTime =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    when id=#{device.id} then #{device.bindTime}
                </foreach>
            </trim>
            <trim prefix="lastUpdateTime =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    <if test="device.lastUpdateTime !=null">
                        when id=#{device.id} then #{device.lastUpdateTime}
                    </if>
                </foreach>
            </trim>
            <trim prefix="updateUserId =case" suffix="end,">
                <foreach collection="list" item="device" index="index">
                    <if test="device.updateUserId !=null">
                        when id=#{device.id} then #{device.updateUserId}
                    </if>
                </foreach>
            </trim>
        </trim>
        where
        id in
        <foreach collection="list" index="index" item="device" separator="," open="(" close=")">
            #{device.id,jdbcType=BIGINT}
        </foreach>
    </update>


    <update id="updateStatus" parameterType="com.huanke.iot.base.po.device.DevicePo">

        update
        <include refid="tableName"/>
        <set>
            <if test="assignStatus != null">
                assignStatus = #{assignStatus},assignTime = sysdate
            </if>
            <if test="bindStatus != null">
                bindStatus = #{bindStatus},bindTime = sysdate
            </if>
            <if test="onlineStatus != null">
                onlineStatus = #{onlineStatus},
            </if>
            <if test="enableStatus != null">
                enableStatus = #{enableStatus},
            </if>
            <if test="workStatus != null">
                workStatus = #{workStatus},
            </if>
            lastUpdateTime = #{lastUpdateTime},
            updateUserId = #{updateUserId}
        </set>
        where
        deviceId = #{deviceId}
    </update>

    <update id="updateAssignStatus" parameterType="com.huanke.iot.base.po.device.DevicePo">
        update
        <include refid="tableName"/>
        <set>
            assignStatus = #{assignStatus},
            assignTime = #{assignTime},
            lastUpdateTime = #{lastUpdateTime},
            updateUserId = #{updateUserId}
        </set>
        WHERE id = #{id}
        <!--<foreach collection="list" index="index" item="item" open="(" separator="," close=")">-->
        <!--#{item}-->
        <!--</foreach>-->
    </update>

    <update id="updateOnlyDeviceId" parameterType="com.huanke.iot.base.po.device.DevicePo">
        update
        <include refid="tableName"/>
        set wxDeviceId = #{wxDeviceId} where id = #{id}
    </update>
    <select id="selectAll" resultType="com.huanke.iot.base.po.device.DevicePo">
        select * from
        <include refid="tableName"/>
    </select>

    <!--单条删除-->
    <delete id="deleteDevice" parameterType="com.huanke.iot.base.po.device.DevicePo">
        delete from
        <include refid="tableName"/>
        <where>
            mac = #{mac}
        </where>
    </delete>

    <!--单条删除-->
    <delete id="deleteDeviceById" parameterType="java.lang.Integer">
        delete from
        <include refid="tableName"/>
        <where>
            id = #{id}
        </where>
    </delete>
    <!--批量删除-->
    <delete id="deleteDeviceBatch" parameterType="java.util.List">
        delete from
        <include refid="tableName"/>
        where id in
        <foreach collection="list" item="item" separator="," open="(" close=")">
            #{item.id,jdbcType=BIGINT}
        </foreach>
    </delete>

    <select id="getCustomerId" parameterType="com.huanke.iot.base.po.device.DevicePo" resultType="java.lang.Integer">
        select customerId
        from t_device_customer_relation
        where deviceId = #{id}
    </select>

    <select id="selectChildDeviceListByHostDeviceId" parameterType="java.lang.Integer"
            resultType="com.huanke.iot.base.po.device.DevicePo">
        select * from
        <include refid="tableName"/>
        WHERE hostDeviceId = #{hostDeviceId}
        AND status = 1
    </select>

    <update id="deleteById" parameterType="java.lang.Integer">
        update
        <include refid="tableName"/>
        <set>
            status = 2
        </set>
        WHERE id = #{id}
    </update>

    <select id="getByHostDeviceIdAndTypeId" resultType="com.huanke.iot.base.po.device.DevicePo">
        select * from
        <include refid="tableName"/>
        WHERE hostDeviceId = #{hostDeviceId}
        AND childId = #{childId}
        limit 1
    </select>

    <select id="queryChildDeviceCount" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        select count(1) from
        <include refid="tableName"/>
        WHERE hostDeviceId = #{hostDeviceId}
        and status = 1
    </select>

    <select id="queryChildDeviceIds" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        select id from
        <include refid="tableName"/>
        WHERE hostDeviceId = #{hostDeviceId}
        and status = 1
    </select>

    <select id="queryChildDevice" parameterType="java.lang.Integer" resultType="com.huanke.iot.base.po.device.DevicePo">
        select * from
        <include refid="tableName"/>
        WHERE hostDeviceId = #{hostDeviceId}
        and status = 1
    </select>

    <select id="getChildDevice" resultType="com.huanke.iot.base.po.device.DevicePo">
        select * from
        <include refid="tableName"/>
        WHERE hostDeviceId = #{hostDeviceId}
        AND childId = #{childId}
        and status = 1
    </select>

    <select id="selectDeviceCountByCustomer" resultType="java.util.HashMap">
        SELECT
        FROM_UNIXTIME( d.assignTime / 1000, '%m月' ) deviceMonth,
        count( 1 ) deviceCount
        FROM
        t_device d,t_device_customer_relation r
        WHERE
        1=1
        and d.id= r.deviceId
        and r.customerId = #{customerId}
        and FROM_UNIXTIME( d.assignTime / 1000, '%Y' ) = #{nowYear}
        <if test="status != null">
            and d.status = #{status}
        </if>
        GROUP BY
        FROM_UNIXTIME( d.assignTime / 1000, '%m月' )

    </select>

    <select id="selectDeviceCount" resultType="java.util.HashMap">

        SELECT
        FROM_UNIXTIME( d.createTime / 1000, '%m月' ) deviceMonth,
        count( 1 ) deviceCount
        FROM
        t_device d
        WHERE
        1=1
        and FROM_UNIXTIME( d.createTime / 1000, '%Y' ) = #{nowYear}
        <if test="status != null">
            and d.status = #{status}
        </if>
        GROUP BY
        FROM_UNIXTIME( d.createTime / 1000, '%m月' )
    </select>

    <select id = "selectData" resultType="java.lang.Integer">
        select count(*) from  <include refid="tableName"/>
        where
        createTime >= #{startTime}
        <![CDATA[
        and createTime <= #{endTime}
            ]]>
        and
        status = 1
    </select>
</mapper>